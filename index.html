<!DOCTYPE HTML>

<html>
    <head>
        
            
            
                <title>Kuro Usada ga! - Kuro Usada ga!</title>
            
        

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="generator" content="Hugo 0.30.2" />
        


        
        
            
                <meta name="description" content="Kuro Usada ga! Iru! Koko ni!">
            
        

        <meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Kuro Usada ga!"/>
<meta name="twitter:description" content="Kuro Usada ga! Iru! Koko ni!"/>

        <meta property="og:title" content="Kuro Usada ga!" />
<meta property="og:description" content="Kuro Usada ga! Iru! Koko ni!" />
<meta property="og:type" content="website" />
<meta property="og:url" content="http://kurousada.ga/" />



<meta property="og:updated_time" content="2017-12-01T03:00:00&#43;09:00"/>










        
<meta itemprop="name" content="Kuro Usada ga!">
<meta itemprop="description" content="Kuro Usada ga! Iru! Koko ni!">


        

        
        
        
            
        

        
        

        
            
            
                
                    <link rel="stylesheet" href="http://kurousada.ga/css/site.min.css">
                
            
                
                    <link rel="stylesheet" href="http://kurousada.ga/css/main.css">
                
            
            
        

        
            
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-99969227-1', 'auto');
ga('send', 'pageview');
</script>

        
        
    </head>
    <body>

      
      <div id="wrapper">

    
    
<header id="header">
    
        <h1><a href="http://kurousada.ga/">Kuro Usada ga!</i></a></h1>
    

    <nav class="links">
        <ul>
            
                <li>
                    <a href="http://kurousada.ga/posts">
                        Posts
                    </a>
                </li>
            
                <li>
                    <a href="http://kurousada.ga/categories">
                        Categories
                    </a>
                </li>
            
                <li>
                    <a href="http://kurousada.ga/about">
                        About
                    </a>
                </li>
            
        </ul>
    </nav>
    <nav class="main">
        <ul>
            
            <li id="share-nav" class="share-menu" style="display:none;">
                <a class="fa-share-alt" href="#share-menu">Share</a>
            </li>
            
            
            <li class="back-to-top-link">
                <a class="fa-arrow-up" href="#top">Top</a>
            </li>
            <li class="menu">
                <a class="fa-bars" href="#menu">Menu</a>
            </li>
        </ul>
    </nav>
</header>


<section id="menu">

    
        <section>
            <div id="search">
              <script async src="https://cse.google.com/cse.js?cx=018175984642811849393:lior-73d8wc"></script>
              <gcse:searchbox-only></gcse:searchbox-only>
            </div>
            
        </section>

    
        <section>
            <ul class="links">
                
                    <li>
                        <a href="http://kurousada.ga/posts">
                            <h3>
                                
                                Posts
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="http://kurousada.ga/categories">
                            <h3>
                                
                                Categories
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="http://kurousada.ga/about">
                            <h3>
                                
                                About
                            </h3>
                        </a>
                    </li>
                
            </ul>
        </section>

    
        <section>
            <ul class="links">
                <header>
                    <h3>Recent Posts</h3>
                </header>
                
                    
                

                
                    <li>
                        <a href="http://kurousada.ga/posts/tech/cross-compile-dll-using-golang-on-linux/"><p>Goを使ってDLLをクロスコンパイル on Linux</p></a>
                    </li>
                
                    <li>
                        <a href="http://kurousada.ga/posts/disney/tds/eat-them-in-tokyo-disney-sea/"><p>ディズニーシーではこれを食え！</p></a>
                    </li>
                
                    <li>
                        <a href="http://kurousada.ga/posts/disney/tds/drink-them-in-tokyo-disney-sea/"><p>ディズニーシーではこれを飲め！</p></a>
                    </li>
                
                    <li>
                        <a href="http://kurousada.ga/posts/disney/disney-food-dogma/"><p>ディズニー・フードの鉄則</p></a>
                    </li>
                
                    <li>
                        <a href="http://kurousada.ga/posts/tech/how-to-get-back-old-times-offline/"><p>オフラインでも懐かしいあの頃に戻る方法</p></a>
                    </li>
                
            </ul>
        </section>

    
        
</section>

    
    <div id="main">
        
            <article class="post">
    <header>
    <div class="title">
        
            <h2><a href="http://kurousada.ga/posts/tech/cross-compile-dll-using-golang-on-linux/">Goを使ってDLLをクロスコンパイル on Linux</a></h2>
        
        
            <p>Cross Compile Dll Using Golang on Linux</p>
        
    </div>
    <div class="meta">
        
        
            
                
            
        

        <time class="published" datetime='2017-12-01'>
            December 1, 2017
        </time>
        
        <span class="author">Kuro Usada</span>
        
            <p>16 minute read</p>
        
        
    </div>
</header>


    
    



    
        
    
    
    






    


    
    

    <span class="image featured">
        <img class="featured-data" src="http://kurousada.ga/img/2017/12/cross-compile-dll-using-golang-on-linux/featured" alt="Go Gopher by Renee French" onerror="this.classList.add('on-error')" />
        <span class="featured-alt">Not found</span>
    </span>
    <p class="featured-copyright">
        
            
                <a href="https://blog.golang.org/gopher" target="_blank">
            
            Go Gopher
            
                </a>
            
        
        
            &nbsp;by&nbsp;
            
                <a href="http://reneefrench.blogspot.com/" target="_blank">
            
            Renee French
            
                </a>
            
        
    </p>


    <div id="content">
        <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#必要なもの">必要なもの</a></li>
<li><a href="#全体の流れ">全体の流れ</a></li>
<li><a href="#とりあえず作ってみる">とりあえず作ってみる</a></li>
<li><a href="#もうちょっと詳しく">もうちょっと詳しく</a></li>
<li><a href="#伺かの-shiori-を作る">伺かの SHIORI を作る</a>
<ul>
<li><a href="#伺かとは">伺かとは</a></li>
<li><a href="#ソース">ソース</a></li>
<li><a href="#コンパイルと実行">コンパイルと実行</a></li>
</ul></li>
<li><a href="#その他ハマりポイントとか-tips-とか">その他ハマりポイントとか Tips とか</a>
<ul>
<li><a href="#wine上でのファイルパーミッションとfat32">Wine上でのファイルパーミッションとFAT32</a></li>
<li><a href="#writefile-のエンコーディング">WriteFile()のエンコーディング</a></li>
<li><a href="#go-と-c-の橋渡し">Go と C の橋渡し</a></li>
<li><a href="#c-の関数の返り値">C の関数の返り値</a></li>
<li><a href="#c-の関数を定義したい">C の関数を定義したい！</a></li>
<li><a href="#const-の-go-世界での型はどうすればいいんですか">const の Go 世界での型はどうすればいいんですか？</a></li>
<li><a href="#struct-や-interface-は-union-は">struct や interface は？ union は？</a></li>
<li><a href="#go-build-x">go build -x</a></li>
</ul></li>
<li><a href="#まとめ">まとめ</a></li>
</ul></li>
</ul>
</nav>
        <p><a href="https://mattn.kaoriya.net/">mattn</a> さんによる「<a href="https://mattn.kaoriya.net/software/lang/go/20160921010820.htm">Golang で Windows の DLL を作る方法</a>」という記事を参考に、cgo を使って Linux 上で DLL をクロスコンパイルします。
Go を使えば、Windows なしで<a href="https://ja.wikipedia.org/wiki/伺か">伺か</a>の SHIORI.DLL を作成することができます。ので、作ります。</p>

<p></p>

<p>この記事は <a href="https://qiita.com/advent-calendar/2017/go4">Go Advent Calender 2017（その4）</a> の 1日目の記事です。</p>

<p>明日は <a href="https://qiita.com/kami_zh">kami_zh</a> さんによる Linux プログラミング関連の記事だそうです。</p>

<p>この記事で作成する SHIORI を基に、もうちょっと機能的にしたサンプルゴーストを作りました：<a href="https://github.com/kurousada/gohst/">github.com/kurousada/gohst</a></p>

<h2 id="必要なもの">必要なもの</h2>

<ul>
<li>Linux PC</li>
<li><a href="https://golang.org/">Go</a> （たぶん）1.5以上</li>
<li><a href="http://www.mingw.org/">MinGW</a></li>
<li><a href="https://www.winehq.org/">Wine</a>（伺かベースウェアの<a href="http://ssp.shillest.net/">SSP</a> を動かすためです。SSP を使わないなら要りません）</li>
</ul>

<p>この記事は以下の環境で作成しています。</p>

<ul>
<li><a href="https://linuxmint.com/">Linux Mint</a> 18.2 Sonya Xfce 64bit</li>
<li>Go 1.9.2 linux/amd64 via <a href="https://github.com/syndbg/goenv">goenv</a></li>
<li>mingw-w64 4.0.4-2 via <code>apt install mingw-w64</code> (gcc のバージョンは 5.3.1 です)</li>
<li>wine-1.6.2 via <code>apt install wine</code></li>
</ul>

<h2 id="全体の流れ">全体の流れ</h2>

<p>基本的な流れは「<a href="https://mattn.kaoriya.net/software/lang/go/20160921010820.htm">Golang で Windows の DLL を作る方法</a>」と同じです。</p>

<ol>
<li>MinGW の GCC を環境変数<code>CC</code>に指定して<code>go build --buildmode=c-archieve</code>で<code>libxxx.a</code>を作る</li>
<li>defファイルを作る</li>
<li>MinGW の GCC で<code>-Wl,--allow-multiple-definition</code>を指定して DLL を作る</li>
</ol>

<p>なお、Linux ネイティブの GCC ではなく、<strong>MinGW の GCC を使う</strong>ことに注意してください。</p>

<h2 id="とりあえず作ってみる">とりあえず作ってみる</h2>

<p>DLL といえば<a href="https://ja.wikipedia.org/wiki/伺か">伺か</a>の SHIORI（shiori.dll）ですね！
（え、伺かを「知らない」……？それは……）</p>

<p>mattn さんも「<a href="https://qiita.com/mattn/items/b7889e3c036b408ae8bd">本物の golang を&hellip; 本物の Gopher を、お見せしますよ。</a>」という記事で Pure Go の伺かベースウェア（のようなもの）を実装されてましたし！</p>

<p><a href="http://ssp.shillest.net/ukadoc/manual/spec_dll.html">SHIORI/3.0 の仕様</a>によると、<code>shiori.dll</code>は以下の3つの関数をエクスポートする必要があります。
（伺か？SHIORI？知らねーよ！！って方には後で説明するので、とりあえず下の 3つの関数をエクスポートした DLL を作るんだということを了解していただければと思います）</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#66d9ef">extern</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;C&#34;</span> <span style="color:#66d9ef">__declspec</span>(dllexport) BOOL <span style="color:#66d9ef">__cdecl</span> load(HGLOBAL h, <span style="color:#66d9ef">long</span> len);
<span style="color:#66d9ef">extern</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;C&#34;</span> <span style="color:#66d9ef">__declspec</span>(dllexport) BOOL <span style="color:#66d9ef">__cdecl</span> unload(<span style="color:#66d9ef">void</span>);
<span style="color:#66d9ef">extern</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;C&#34;</span> <span style="color:#66d9ef">__declspec</span>(dllexport) HGLOBAL <span style="color:#66d9ef">__cdecl</span> request(HGLOBAL h, <span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>len);</code></pre></div>
<p>まずは引数なしで何もしない<code>unload()</code>関数を Go で書いてエクスポートしてみましょう。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#75715e">/* 
</span><span style="color:#75715e">   #include &lt;windows.h&gt;
</span><span style="color:#75715e"> */</span>
<span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;C&#34;</span>

<span style="color:#f92672">import</span> (
    <span style="color:#e6db74">&#34;fmt&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>(){}

<span style="color:#75715e">//export unload
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">unload</span>() <span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">BOOL</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">TRUE</span>
}</code></pre></div>
<p>この<code>main.go</code>をコンパイルして<code>libshiori.a</code>を作ります。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">CGO_ENABLED<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> GOOS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;windows&#34;</span> GOARCH<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;386&#34;</span> CC<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;i686-w64-mingw32-gcc-win32&#34;</span> go build -buildmode<span style="color:#f92672">=</span>c-archive -o libshiori.a</code></pre></div>
<p><code>libshiori.a</code>の中から<code>unload()</code>をエクスポートするための<code>shiori.def</code>ファイルを書きます。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-def" data-lang="def">LIBRARY	shiori

EXPORTS
    unload</code></pre></div>
<p>で、この<code>shiori.def</code>と<code>libshiori.a</code>を基に<code>shiori.dll</code>を作ります。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">i686-w64-mingw32-gcc-win32 -shared -o shiori.dll shiori.def libshiori.a -Wl,--allow-multiple-definition -static -lstdc++ -lwinmm -lntdll -lws2_32</code></pre></div>
<p><code>shiori.dll</code>ができました！
オブジェクトファイルに含まれるシンボルを教えてくれる<code>nm</code>コマンドで確認してみます。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ nm shiori.dll | grep unload
6bad70d0 T __cgoexp_637397f8f89c_unload
6b9c1500 T _unload
6bad7110 T main._cgoexpwrap_637397f8f89c_unload
6bad7590 T main.unload</code></pre></div>
<p>ちゃんと<code>_unload</code>がエクスポートされてます。
やったー！</p>

<p>おそらく<code>main.unload</code>が Go の関数、<code>_unload</code>は cgo が出力したラッパ関数で、この<code>_unload</code>から<code>main.unload</code>が呼ばれることでGoの関数が実行されるんじゃないかな〜（このへん曖昧）。</p>

<h2 id="もうちょっと詳しく">もうちょっと詳しく</h2>

<p>上のコードを見て、「<strong>GCC を MinGW のやつにしただけじゃんwww</strong>」という Go 強者の方は以上です。
お疲れ様でした。</p>

<p>以下、「なんとなくわかるけどもうちょい詳しく！」というあなた（わたし）のために順を追って説明します。</p>

<p>Go でライブラリを作るときには <strong>cgo</strong> という、Go から C を呼んだり C から Go を呼んだりする機能を使います。
cgo がソースの一部を C のコードに変換、GCC でコンパイルして Go のコードとリンクすることにより、 Go で C のコードっぽいものを書くことができるようになります。</p>

<p>それではソースを追っていきましょう。
冒頭にいきなり大事なポイントです。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span></code></pre></div>
<p>コンパイルするにはパッケージ<code>main</code>と<code>main()</code>関数が必要です。
これはたぶん GO コードをコンパイルするときは必ず必要なんじゃないかと思ってます。</p>

<p>さて、パッケージ宣言の後、一番最初のコメント部分を <strong>preamble</strong> と呼びます。
「序文」とでも訳せましょうか、この部分に書いた C コードは cgo によって抽出されて GCC でコンパイルされるときにファイルの先頭にくっつけられます。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#75715e">/* 
</span><span style="color:#75715e">   #include &lt;windows.h&gt;
</span><span style="color:#75715e"> */</span></code></pre></div>
<p>で、その preamble の後に<code>import &quot;C&quot;</code>です。
これは「C パッケージをインポートして cgo 使うよ〜」って感じの宣言です（たぶん）。</p>

<p>ここで大事なポイント2つ目。</p>

<p>preamble と<code>import &quot;C&quot;</code>の間に<strong>空行を入れてはいけません</strong>！
つまり、以下のコードはダメです。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#75715e">/* 
</span><span style="color:#75715e">   #include &lt;windows.h&gt;
</span><span style="color:#75715e"> */</span>

<span style="color:#75715e">// フリーダムなオレは、ここに空行を入れちゃうぜぇ〜
</span><span style="color:#75715e"></span>
<span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;C&#34;</span></code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ CGO_ENABLED<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> GOOS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;windows&#34;</span> GOARCH<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;386&#34;</span> CC<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;i686-w64-mingw32-gcc-win32&#34;</span> go build -buildmode<span style="color:#f92672">=</span>c-archive -o libshiori.a
<span style="color:#75715e"># command-line-arguments
</span><span style="color:#75715e"></span>./main.go:19:15: could not determine kind of name <span style="color:#66d9ef">for</span> C.BOOL
./main.go:20:12: could not determine kind of name <span style="color:#66d9ef">for</span> C.TRUE</code></pre></div>
<p>怒られます。</p>

<p>さて、<code>fmt</code>など必要なパッケージもインポートしたら、<code>main()</code>を書いておきます。
これはもちろん<code>main</code>パッケージ内ならどこでもいいです。
中身は空で、何もしません。</p>

<p>やっと真打登場です。
<code>unload()</code>を書きます。
このとき、エクスポートしたい関数の直前に<code>//export 関数名</code>と書くとエクスポートされますので、書きます。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#75715e">//export unload
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">unload</span>() <span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">BOOL</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">TRUE</span>
}</code></pre></div>
<p>そして、大事なポイント3つ目。</p>

<p><code>//export</code>の<code>//</code>と<code>export</code>の間に<strong>空白を入れてはいけません！</strong></p>

<p>これにめっちゃハマってしまい、2時間くらい無駄にしました。
エラーは出ず、ただエクスポートされなくなるだけなので原因を特定するのがかなり厳しいです。
お気をつけ下さい。</p>

<p>肝心の関数ですが、C における<code>unload()</code>のプロトタイプは以下です。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#66d9ef">extern</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;C&#34;</span> <span style="color:#66d9ef">__declspec</span>(dllexport) BOOL <span style="color:#66d9ef">__cdecl</span> unload(<span style="color:#66d9ef">void</span>);</code></pre></div>
<p>これを Go の関数にするとこうなります。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">unload</span>() <span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">BOOL</span></code></pre></div>
<p>C パッケージをインポートしたので、C の世界の値を使うことができます。
<code>C.BOOL</code>が C の世界の<code>windows.h</code>で宣言されている型（実際はマクロ）ですね。</p>

<p>型名は<code>C.型名</code>、マクロも<code>C.マクロ名</code>、関数も<code>C.関数()</code>で呼び出せます。
ポインタも<code>*C.型名</code>のようにして使えます。
ただし、<code>void*</code>は<code>unsafe.Pointer</code>ですので、<code>unsafe</code>パッケージが必要です。</p>

<p>で、<code>unload()</code>はとりあえず<code>C.TRUE</code>を返しておきます。
コードは以上です。</p>

<p>これをコンパイルしてまずは<code>libshiori.a</code>を作ります。</p>

<p>このとき、環境変数<code>CGO_ENABLED=1</code>と<code>GOOS=&quot;windows&quot;</code>、<code>GOARCH=386</code>、そして<code>CC=MinGWのGCCコマンド</code>を指定します。</p>

<p>今回は 32bit DLLを作るため、<code>GOARCH=386</code>を指定し、MinGW の GCC は 64bit環境で 32bitプログラムにコンパイルする<code>i686-w64-mingw32-gcc-win32</code>を使います（MinGWのgccコマンド名については<a href="https://kakurasan.blogspot.jp/">kakurasanのLinux備忘録</a>の「<a href="https://kakurasan.blogspot.jp/2015/07/debianubuntu-mingw-crosscompile.html">Debian/Ubuntuでmingw-w64を用いてWindows向けのプログラムをコンパイルする</a>」にわかりやすい一覧があります）。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">CGO_ENABLED<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> GOOS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;windows&#34;</span> GOARCH<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;386&#34;</span> CC<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;i686-w64-mingw32-gcc-win32&#34;</span> go build -buildmode<span style="color:#f92672">=</span>c-archive -o libshiori.a</code></pre></div>
<p>コンパイルすると<code>libshiori.a</code>と<code>libshiori.h</code>というファイルができます。
<code>libshiori.h</code>は今回、使いません。</p>

<p>あとは GCC で<code>libshiori.a</code>から DLL を作るだけなんですが、そのために<code>libshiori.a</code>からエクスポートしたい関数名を def ファイルに書く必要があります。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-def" data-lang="def">LIBRARY	shiori

EXPORTS
    unload</code></pre></div>
<p><code>LIBRARY</code>にライブラリ名を書き、<code>EXPORTS</code>にエクスポートする関数名を改行区切りで列挙します。
この<code>EXPORTS</code>部分で実際に<code>GetProcAddress()</code>を使って呼び出すときの名前を決めます。
もし<code>//export 関数名</code>でエクスポートした関数名と違う関数名にしたいときは、こう書きます。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-def" data-lang="def">LIBRARY	shiori

EXPORTS
    unload = Unload</code></pre></div>
<p>この場合、Go 側で<code>//export Unload</code>した関数を DLL から呼び出すときには<code>unload</code>という名前を使うことを示します。
他にも<code>unload@0</code>とすると番号で呼び出したりできるそうですが、そこら辺は Google 先生に聞いてください。</p>

<p>さて、この def ファイルを<code>shiori.def</code>として GCC を叩き、DLL を作ってもらいましょう！</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">i686-w64-mingw32-gcc-win32 -shared -o shiori.dll shiori.def libshiori.a -Wl,--allow-multiple-definition -static -lstdc++ -lwinmm -lntdll -lws2_32</code></pre></div>
<p>なんやらいろいろオプションがついてますね。</p>

<p>まず、cgo で使ったコンパイラと同じコンパイラを使ったほうが良いでしょう（「いや、違うのでやりたい！」というなら止めませんが……）。</p>

<p>そして、共有ライブラリなので<code>-shared</code>です。
出力ファイル名と先ほど作った def ファイルを指定して、Go の関数が入っている<code>libshiori.a</code>も指定します。</p>

<p>それから、cgo の吐くオブジェクトファイルはどうやら同じ定義とみなされるものが複数入っているようなので<code>-Wl,--allow-multiple-definition</code>をつけます（このへんよくわからないけど、mattnさんがつけてたので）。</p>

<p><code>stdc++</code>や<code>winmm</code>、<code>ntdll</code>、<code>ws2_32</code>といったライブラリも使うので（preamble で<code>windows.h</code>インクルードしましたよね？）、<code>-static</code>をつけて静的にリンクしておきます。
このときそれぞれのライブラリの依存に応じて順番に書いてあげないとリンカが「ふぇぇ……シンボルが見つからないよぅ」といったエラーを出します。</p>

<p>ちなみに、<code>i686-w64-mingw32-gcc-win32</code>は 32bitをターゲットにして出力しますので GCCの<code>-m32</code>オプションはつけなくても大丈夫です。</p>

<p>ここまで成功すれば<code>shiori.dll</code>ができているはずです。</p>

<h2 id="伺かの-shiori-を作る">伺かの SHIORI を作る</h2>

<p>なんとなくやり方がわかったところで、残りの 2つの関数を実装して SHIORI を作ります。</p>

<h3 id="伺かとは">伺かとは</h3>

<p>伺かはデスクトップマスコットと呼ばれるアプリケーションで、デスクトップに（大抵は）かわいい女の子と謎の生物が住み着いて勝手に漫才しているのを眺めるソフトです。
私の説明が下手なので楽しくなさそうですが、めっちゃ楽しいです。
無料で利用でき、自分でキャラクターを作ることができたり、<a href="http://ukagaka.dojin.com/">オンリーイベント</a>があったりします。</p>

<p>仕組みについて超簡易的な説明をすると、「ベースウェア」と呼ばれるクライアントからイベントが飛んでくるので、それに応じて「SHIORI」と呼ばれるサーバがキャラが話す内容や表情の画像などを返すというやり取りでできています。
キャラクターは見た目と脳に当たる部分の分離が図られており、それぞれ「シェル」と「ゴースト」と呼ばれます。
SHIORI は「ゴースト」の根幹とも言える、人格を司る部分を担っていて、DLL で実装します。</p>

<p>普通はリクエストに応じて専用のスクリプトなどを解釈・実行し、レスポンスを生成する DLL を C や C++ で書きます。
そうすることで SHIORI のすべてを DLL で賄うという大変な作業を回避して、ロジックとデータの分離を図ります。
が、この記事ではそんなこと考えず超絶シンプルな「リクエストを全部無視する、何もしない SHIORI」を Go で書いてみたいと思います。</p>

<p>この記事で説明している以外の伺か関連の仕様は <a href="http://ssp.shillest.net/ukadoc/manual/">UKADOC</a> か Google 先生に(ry</p>

<h3 id="ソース">ソース</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#75715e">/* 
</span><span style="color:#75715e">   #define UNICODE
</span><span style="color:#75715e">   
</span><span style="color:#75715e">   #include &lt;windows.h&gt;
</span><span style="color:#75715e">   #include &lt;stdlib.h&gt;  // free()
</span><span style="color:#75715e">   #include &lt;string.h&gt;  // strlen(), memcpy()
</span><span style="color:#75715e">*/</span>
<span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;C&#34;</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;bytes&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;unsafe&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {}

<span style="color:#75715e">//export load
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">load</span>(<span style="color:#a6e22e">h</span> <span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">HGLOBAL</span>, <span style="color:#a6e22e">length</span> <span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">long</span>) <span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">BOOL</span> {
	<span style="color:#75715e">//
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// extern &#34;C&#34; __declspec(dllexport) BOOL __cdecl load(HGLOBAL h, long length);
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// h      = DLL のパス（文字列）
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// length = h のサイズ
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// h は GlobalAlloc(GPTR, length) で確保されたメモリ領域へのポインタで、DLL 側で GlobalFree(h) する必要があります。
</span><span style="color:#75715e"></span>	
    <span style="color:#75715e">// せっかくサイズ情報があるので C.GoStringN() を使います。
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// ここは C.GoString() でも大丈夫なはず。
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// というか long -&gt; int のキャストってどうなんでしょう？
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// あ、HGLOBAL は void* なので、char* に相当する *C.char にキャストしています。
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">curDir</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">GoStringN</span>((<span style="color:#f92672">*</span><span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">char</span>)(<span style="color:#a6e22e">h</span>), (<span style="color:#a6e22e">C</span>.<span style="color:#66d9ef">int</span>)(<span style="color:#a6e22e">length</span>))
	
	<span style="color:#75715e">// DLL のパスが入っているメモリを開放します。
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">GlobalFree</span>(<span style="color:#a6e22e">h</span>)
    
    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;[shiori] Load&#34;</span>)
    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;[shiori] curDir = \&#34;%s\&#34;\n&#34;</span>, <span style="color:#a6e22e">curDir</span>)
    
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">TRUE</span>
}

<span style="color:#75715e">//export unload
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">unload</span>() <span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">BOOL</span> {
    <span style="color:#75715e">//
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// extern &#34;C&#34; __declspec(dllexport) BOOL __cdecl unload(void);
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 何もしません。
</span><span style="color:#75715e"></span>    
    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;[shiori] Unload&#34;</span>)
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">TRUE</span>
}

<span style="color:#75715e">//export request
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">request</span>(<span style="color:#a6e22e">h</span> <span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">HGLOBAL</span>, <span style="color:#a6e22e">length</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">long</span>) <span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">HGLOBAL</span> {
    <span style="color:#75715e">// 
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// extern &#34;C&#34; __declspec(dllexport) HGLOBAL __cdecl request(HGLOBAL h, long *length);
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// h      = リクエスト（文字列）
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// length = h のサイズ（load() と違ってポインタなので注意）
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// h は GlobalAlloc(GPTR, length) で確保されたメモリ領域へのポインタで、DLL 側で GlobalFree(h) する必要があります。
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// リクエストの文字コードは Charset ヘッダを見るまでわかりませんが、ここでは簡便のため UTF-8 で来ると仮定しています。
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 伺かベースウェアのデファクトスタンダードである SSP は UTF-8 で送ってくれるので、とりあえず、です。
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// レスポンスは h とは別に GlobalAlloc(GPTR, n) し、そこに書き込みます。
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// そして書き込んだ長さ n を length に書き込み、レスポンスが入ったメモリ領域へのポインタを返します。
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// こっちの GlobalFree() はベースウェアがしてくれます。
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// レスポンスも簡便のため一律に「204 No Content」を返しています。
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// リクエストが入っているメモリのサイズを取得します。
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// load() と違い、ポインタなので注意してください。
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">req_size</span> <span style="color:#f92672">:=</span> (<span style="color:#f92672">*</span><span style="color:#a6e22e">length</span>)

    <span style="color:#75715e">// せっかくサイズ情報があるので C.GoStringN() を使います。
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// ここは C.GoString() でも大丈夫なはず。
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">req_str</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">GoStringN</span>((<span style="color:#f92672">*</span><span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">char</span>)(<span style="color:#a6e22e">h</span>), (<span style="color:#a6e22e">C</span>.<span style="color:#66d9ef">int</span>)(<span style="color:#a6e22e">req_size</span>))

    <span style="color:#75715e">// レスポンスが入っているメモリを開放します。
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">GlobalFree</span>(<span style="color:#a6e22e">h</span>)

    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;[shiori] Request\n%s\n&#34;</span>, <span style="color:#a6e22e">req_str</span>)

    <span style="color:#75715e">// 正常終了だけどリクエストを無視するレスポンスを返します。
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">res_str</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;SHIORI/3.0 204 No Content\nCharset: UTF-8\n&#34;</span>

    <span style="color:#75715e">// Go string の res_str を C で扱えるように、char の配列にします。
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// C.CString() は malloc() してメモリを確保し、そこに Go string の内容をコピーする関数です。
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">res_buf</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">CString</span>(<span style="color:#a6e22e">res_str</span>)
    
    <span style="color:#75715e">// C.CString() で確保したメモリは自前で free() してやる必要があります。
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// この時、res_buf の型は *C.char なので unsafe.Pointer (つまり void*) にキャストします。
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// defer も使えるなんて、便利ですね。
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">free</span>((<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>)(<span style="color:#a6e22e">res_buf</span>))
    
    <span style="color:#75715e">// バッファのサイズを調べます。
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// len(res_str) でもいいんですが、後でキャストの手間が少しだけ省けるので strlen() を呼んでいます。
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">res_size</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">strlen</span>(<span style="color:#a6e22e">res_buf</span>)
    
    <span style="color:#75715e">// 調べたサイズを基に、レスポンス用のメモリを確保します。
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// SIZE_T は Win32 API での size_t です。
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">ret</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">GlobalAlloc</span>(<span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">GPTR</span>, (<span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">SIZE_T</span>)(<span style="color:#a6e22e">res_size</span>))
    
    <span style="color:#75715e">// 確保したメモリにレスポンスをコピーします。
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// ret の型は C.HGLOBAL (つまり void*) なのですが、明示的に unsafe.Pointer にキャストしてやらねばなりません。
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 逆に res_size は strlen() を使ったために型が C.size_t となり、キャストする必要がありません。
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">memcpy</span>((<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>)(<span style="color:#a6e22e">ret</span>), (<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>)(<span style="color:#a6e22e">res_buf</span>), <span style="color:#a6e22e">res_size</span>)
    
    <span style="color:#75715e">// レスポンスのサイズを request() の第 2引数である length ポインタが指す先にキャストして書き込んでやります。
</span><span style="color:#75715e"></span>    <span style="color:#f92672">*</span><span style="color:#a6e22e">length</span> = (<span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">long</span>)(<span style="color:#a6e22e">res_size</span>)
    
    <span style="color:#75715e">// レスポンスが入ったメモリ領域へのポインタ（HGLOBAL = void* です）を返して終了！
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ret</span>
}</code></pre></div>
<h3 id="コンパイルと実行">コンパイルと実行</h3>

<p>毎回コマンドを手打ちするのはたるいので、コンパイル用の簡単なシェルスクリプトを書いておきます。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e">#!/usr/bin/sh
</span><span style="color:#75715e"></span>
CGO_ENABLED<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> GOOS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;windows&#34;</span> GOARCH<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;386&#34;</span> CC<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;i686-w64-mingw32-gcc-win32&#34;</span> go build -buildmode<span style="color:#f92672">=</span>c-archive -o libshiori.a

<span style="color:#75715e"># go build が成功したら dll を作る
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$?<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    i686-w64-mingw32-gcc-win32 -shared -o shiori.dll shiori.def libshiori.a -Wl,--allow-multiple-definition -static -lstdc++ -lwinmm -lntdll -lws2_32
<span style="color:#66d9ef">fi</span></code></pre></div>
<p>これを<code>compile.sh</code>とでも名付けて<code>chmod +x</code>しておけば、コンパイルは<code>./compile.sh</code>でできるようになります（Makefile は辛いので書きたくありません……）。</p>

<p>この DLL を実行するためには、Python や Go で呼び出しコードを書くか、<a href="http://ssp.shillest.net/">SSP</a> などの伺かベースウェアをインストールする必要があります。
<a href="http://ssp.shillest.net/">SSP</a> は2017年現在最も活発に開発されている伺かのベースウェアで、Wine で動かすことができます（他にも <a href="http://ninix-aya.osdn.jp/">ninix-aya</a> という Wine なしで動くベースウェアもあります）。</p>

<p>SSP を wine で実行するには、以下のコマンドを叩きます。
このとき、適切なゴーストの栞として <code>shiori.dll</code> が読み込まれるようにしてください。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">wine /path/to/ssp/installation/folder/ssp.exe</code></pre></div>
<p>Wine の fixme がたくさん出てきますが、ちゃんと動きます。</p>

<p>なお、SHIORI/3.0 を読み書きできるありがたい Go のライブラリ「<a href="https://github.com/Narazaka/shiorigo">github.com/Narazaka/shiorigo</a>」を<a href="https://narazaka.net/">奈良阪某</a>さんが公開してくれていますので、本格的に栞を書くなら<code>go get github.com/Narazaka/shiorigo</code>した方がよいでしょう。</p>

<p>アドベントカレンダーに間に合うように Go で SHIORI を書いたゴーストを作っていますが、ネタが足りてないのでどうなることやら……
と書くつもりでしたが、ネタがなくても「サンプルゴーストです」と言いはればいいかと思って <a href="https://github.com/kurousada/gohst">github.com/kurousada/gohst</a> に上げました。
ここまで解説したソースをちょっと弄ってランダムトークするようにしています。</p>

<h2 id="その他ハマりポイントとか-tips-とか">その他ハマりポイントとか Tips とか</h2>

<h3 id="wine上でのファイルパーミッションとfat32">Wine上でのファイルパーミッションとFAT32</h3>

<p>Wine 上で Go の<code>os</code>パッケージを使ってファイルの読み書きをしようとすると権限がないと怒られてしまいます。
これは FAT32 にファイルパーミッションという概念がないために起こっているようです。</p>

<p>仕方なく直接 Win32API の CreateFile() やら WriteFile() やら CloseFile() やらを叩いたところ、ちゃんと保存できました。</p>

<h3 id="writefile-のエンコーディング">WriteFile()のエンコーディング</h3>

<p>Windows といえば Shift_JIS (cp932) です。
Go の string は UTF-8 だそうで、そのまま安直に WriteFile() するとお化けと豆腐のエレクトリカル・パレードです。</p>

<p>そこで、「<a href="https://ja.stackoverflow.com/questions/6120/goでbyteをshift-jisの文字列に変換する">go - Goで[]byteをshift-jisの文字列に変換する - スタック・オーバーフロー</a>」を参考に Shift_JIS に変換してから書き込んだところ、ハピネスを感じることができました。</p>

<h3 id="go-と-c-の橋渡し">Go と C の橋渡し</h3>

<p>ソースにもいくつか出てきましたが、cgo には C から Go、Go から C の世界への変換関数が用意されています。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#75715e">// Go の string を malloc() で確保したメモリにコピーして C の世界でいじれる char の配列にします。
</span><span style="color:#75715e">// この関数で確保したメモリは自前でfree()する必要があります。
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">CString</span>(<span style="color:#66d9ef">string</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">char</span>

<span style="color:#75715e">// Go の []byte を malloc() で確保したメモリにコピーして C の世界でいじれる配列にします。
</span><span style="color:#75715e">// この関数で確保したメモリは自前でfree()する必要があります。
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">CBytes</span>([]<span style="color:#66d9ef">byte</span>) <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>

<span style="color:#75715e">// C の世界の char 配列を Go の string に変換します。
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">GoString</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">char</span>) <span style="color:#66d9ef">string</span>

<span style="color:#75715e">// C.GoString() のサイズを指定できるバージョンです。
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">GoStringN</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">char</span>, <span style="color:#a6e22e">C</span>.<span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">string</span>

<span style="color:#75715e">// C の配列を Go []byte にします。
</span><span style="color:#75715e">// サイズ指定必須です。
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">GoBytes</span>(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>, <span style="color:#a6e22e">C</span>.<span style="color:#66d9ef">int</span>) []<span style="color:#66d9ef">byte</span></code></pre></div>
<p>Go から C の世界（またはその逆）にアクセスする他の方法は、GoDoc の「<a href="https://golang.org/cmd/cgo/">Command cgo</a>」にまとめられています。</p>

<h3 id="c-の関数の返り値">C の関数の返り値</h3>

<p>C の関数は常に、関数の返り値とエラーという 2つの値を返します。</p>

<p>たとえ<code>void ponyo(void);</code>でも、2つ返ってきます。
そういうときは<code>_</code>を使いましょう。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#a6e22e">ret</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">one</span>(<span style="color:#ae81ff">1</span>)    <span style="color:#75715e">// int one(int);
</span><span style="color:#75715e"></span><span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">ponyo</span>()</code></pre></div>
<p>ただし、<code>C.malloc()</code>は Go 側でラップしているので、返り値は 1つです。
触っちゃいけないところをお触りしたらパニックを起こすようになっているとのこと。</p>

<h3 id="c-の関数を定義したい">C の関数を定義したい！</h3>

<p>自分で書いた C の関数を Go から呼ぶには、</p>

<ol>
<li>プロトタイプ宣言が書かれたヘッダファイルを preamble でインクルード</li>
<li>関数の実体を書いた<code>*.c</code>や<code>*.cpp</code>を GCC などでコンパイル</li>
<li>Go のオブジェクトファイルと 2.をリンク</li>
</ol>

<p>という、とてもめんどっちいやり方をしなくてはいけないようです（いやこれができるのはかなりすごいことなんだけども）。</p>

<p>ただ、単なるラッパ程度の簡単な関数をちょちょっと使いたいときは、<code>static inilne</code>な関数にしましょう。
これなら preamble に書いても怒られません。</p>

<h3 id="const-の-go-世界での型はどうすればいいんですか">const の Go 世界での型はどうすればいいんですか？</h3>

<p>Go の世界では<code>const char*</code>は表せません。
<code>*C.char</code>、つまり<code>char*</code>で我慢するか、どうしても必要なときは<code>char*</code>を受け取って<code>const char*</code>で関数を呼ぶラッパを書きましょう。</p>

<h3 id="struct-や-interface-は-union-は">struct や interface は？ union は？</h3>

<p>「<a href="https://golang.org/cmd/cgo/">Command cgo</a>」をよく読みましょう。</p>

<h3 id="go-build-x">go build -x</h3>

<p><code>go build</code>に<code>-x</code>オプションをつけると、コンパイラが何をしているかが出力されます。
つまり cgo がかなり GCC に頼っていることがわかります。</p>

<h2 id="まとめ">まとめ</h2>

<p>C の代替は Go でいいんじゃないかと思えました。
書きやすくて速くてクロスコンパイルまでできちゃうなんて、すご〜い！</p>

<p>みんな Go を使って新しいゴーストを書けばいいと思うよ！
問題があるとすれば<a href="https://github.com/Ikagaka">如何か</a>への移植ですが、<a href="https://github.com/gopherjs/gopherjs">GopherJS</a> ならやってくれそうな気がしますし……</p>

<p>あと、この記事の最後の方は深夜テンションで書いてるので色々問題があったとしても許してください……
なんでこんな時間に上げることになったかとい(ry</p>

<p>それからそれから、実は Go をちゃんと触るのは初めてなので、間違いとかこうした方がいいよとかあったら教えてください。</p>

<p>えんいー！</p>

<hr />

<p>この記事は <a href="https://qiita.com/advent-calendar/2017/go4">Go Advent Calender 2017（その4）</a> の 1日目の記事です。</p>

<p>明日は <a href="https://qiita.com/kami_zh">kami_zh</a> さんによる Linux プログラミング関連の記事だそうです。</p>
    </div>

    
    <aside id="social-share" class="post-aside">
        <ul class="icons post-aside-content">
            


<li>
  <a href="//twitter.com/share?url=http%3a%2f%2fkurousada.ga%2fposts%2ftech%2fcross-compile-dll-using-golang-on-linux%2f&text=Go%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6DLL%e3%82%92%e3%82%af%e3%83%ad%e3%82%b9%e3%82%b3%e3%83%b3%e3%83%91%e3%82%a4%e3%83%ab%20on%20Linux&via=" target="_blank" class="share-btn twitter">
    <i class="fa fa-twitter"></i>
    <p>Twitter</p>
    </a>
</li>


<li>
  <a href="//plus.google.com/share?url=http%3a%2f%2fkurousada.ga%2fposts%2ftech%2fcross-compile-dll-using-golang-on-linux%2f" target="_blank" class="share-btn google-plus">
    <i class="fa fa-google-plus"></i>
    <p>Google+</p>
  </a>
</li>


<li>
  <a href="//www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fkurousada.ga%2fposts%2ftech%2fcross-compile-dll-using-golang-on-linux%2f" target="_blank" class="share-btn facebook">
    <i class="fa fa-facebook"></i>
    <p>Facebook</p>
  </a>
</li>


<li>
  <a href="//b.hatena.ne.jp/entry/kurousada.ga/posts/tech/cross-compile-dll-using-golang-on-linux/" target="_blank" class="share-btn hatena">
    <i class="icon-hatena"></i>
    <p>Hatena</p>
  </a>
</li>


<li>
  <a href="https://getpocket.com/save?url=http%3a%2f%2fkurousada.ga%2fposts%2ftech%2fcross-compile-dll-using-golang-on-linux%2f" target="_blank" class="share-btn pocket">
    <i class="fa fa-get-pocket"></i>
    <p>Pocket</p>
  </a>
</li>


<li>
  <a href="//reddit.com/submit?url=http%3a%2f%2fkurousada.ga%2fposts%2ftech%2fcross-compile-dll-using-golang-on-linux%2f&title=Go%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6DLL%e3%82%92%e3%82%af%e3%83%ad%e3%82%b9%e3%82%b3%e3%83%b3%e3%83%91%e3%82%a4%e3%83%ab%20on%20Linux" target="_blank" class="share-btn reddit">
    <i class="fa fa-reddit-alien"></i>
    <p>Reddit</p>
  </a>
</li>


<li>
  <a href="//www.linkedin.com/shareArticle?url=http%3a%2f%2fkurousada.ga%2fposts%2ftech%2fcross-compile-dll-using-golang-on-linux%2f&title=Go%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6DLL%e3%82%92%e3%82%af%e3%83%ad%e3%82%b9%e3%82%b3%e3%83%b3%e3%83%91%e3%82%a4%e3%83%ab%20on%20Linux" target="_blank" class="share-btn linkedin">
      <i class="fa fa-linkedin"></i>
      <p>LinkedIn</p>
    </a>
</li>


<li>
  <a href="//www.stumbleupon.com/submit?url=http%3a%2f%2fkurousada.ga%2fposts%2ftech%2fcross-compile-dll-using-golang-on-linux%2f&title=Go%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6DLL%e3%82%92%e3%82%af%e3%83%ad%e3%82%b9%e3%82%b3%e3%83%b3%e3%83%91%e3%82%a4%e3%83%ab%20on%20Linux" target="_blank" class="share-btn stumbleupon">
    <i class="fa fa-stumbleupon"></i>
    <p>StumbleUpon</p>
  </a>
</li>


<li>
  <a href="//www.pinterest.com/pin/create/button/?url=http%3a%2f%2fkurousada.ga%2fposts%2ftech%2fcross-compile-dll-using-golang-on-linux%2f&description=Go%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6DLL%e3%82%92%e3%82%af%e3%83%ad%e3%82%b9%e3%82%b3%e3%83%b3%e3%83%91%e3%82%a4%e3%83%ab%20on%20Linux" target="_blank" class="share-btn pinterest">
    <i class="fa fa-pinterest-p"></i>
    <p>Pinterest</p>
  </a>
</li>


<li>
  <a href="mailto:?subject=Check out this post by Kuro%20Usada&body=http%3a%2f%2fkurousada.ga%2fposts%2ftech%2fcross-compile-dll-using-golang-on-linux%2f" target="_blank" class="share-btn email">
    <i class="fa fa-envelope"></i>
    <p>Email</p>
  </a>
</li>

        </ul>
    </aside>
    

    
    
    

    <footer class="content-footer">
        <ul class="stats">
    
        

        
        
            <li>
                
                
                    

                    

                    

                    
                        Categories
                    
                
            </li>
        
    

    
    
        <li><a href='http://kurousada.ga/categories/linux'>Linux</a></li>
    
        <li><a href='http://kurousada.ga/categories/tech'>tech</a></li>
    
        <li><a href='http://kurousada.ga/categories/golang'>golang</a></li>
    
        <li><a href='http://kurousada.ga/categories/ukagaka'>ukagaka</a></li>
    
</ul>

        <section class="back-to-top-link">
            <a href="#top"><i class="fa fa-arrow-up"></i>&nbsp;Back To Top</a>
        </section>
    </footer>
</article>
<ul class="actions pagination">
    
        <li><a href="http://kurousada.ga/posts/disney/tds/eat-them-in-tokyo-disney-sea/"
                class="button big previous">ディズニーシーではこれを食え！</a></li>
    

    
</ul>



<aside id="comments">

    
        <article id="post-comments" class="post">
            <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "kurousada-ga" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </article>
    

</aside>







<aside class="navi">
<nav id="related-posts" class="navi-content">
  
    <ul class="posts">
      <header>
        <h3>Related Posts</h3>
      </header>
      
        <li class="post">
          <a class="post-link" href="http://kurousada.ga/posts/tech/how-to-get-back-old-times-offline/">
            <article>
              <header>
                <h4 class="post-link-title">オフラインでも懐かしいあの頃に戻る方法</h4>
                <time class="published" datetime="2017-10-31">October 31, 2017</time>
              </header>
            </article>
          </a>
        </li>
      
        <li class="post">
          <a class="post-link" href="http://kurousada.ga/posts/tech/how-to-use-your-original-domain-for-free-with-github-pages/">
            <article>
              <header>
                <h4 class="post-link-title">【無料】Github Pages で独自ドメインを使う</h4>
                <time class="published" datetime="2017-10-30">October 30, 2017</time>
              </header>
            </article>
          </a>
        </li>
      
        <li class="post">
          <a class="post-link" href="http://kurousada.ga/posts/tech/linux/how-to-create-login-themes-on-linux-mint/">
            <article>
              <header>
                <h4 class="post-link-title">Linux Mintのログイン画面のテーマを自作する</h4>
                <time class="published" datetime="2017-10-29">October 29, 2017</time>
              </header>
            </article>
          </a>
        </li>
      
    </ul>
  
</nav>
</aside>





            <section id="share-menu">
    <section id="social-share-nav">
        <ul class="links">
            <header>
                <h3>Share this post <i class="fa fa-smile-o"></i></h3>
            </header>
            


<li>
  <a href="//twitter.com/share?url=http%3a%2f%2fkurousada.ga%2fposts%2ftech%2fcross-compile-dll-using-golang-on-linux%2f&text=Go%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6DLL%e3%82%92%e3%82%af%e3%83%ad%e3%82%b9%e3%82%b3%e3%83%b3%e3%83%91%e3%82%a4%e3%83%ab%20on%20Linux&via=" target="_blank" class="share-btn twitter">
    <i class="fa fa-twitter"></i>
    <p>Twitter</p>
    </a>
</li>


<li>
  <a href="//plus.google.com/share?url=http%3a%2f%2fkurousada.ga%2fposts%2ftech%2fcross-compile-dll-using-golang-on-linux%2f" target="_blank" class="share-btn google-plus">
    <i class="fa fa-google-plus"></i>
    <p>Google+</p>
  </a>
</li>


<li>
  <a href="//www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fkurousada.ga%2fposts%2ftech%2fcross-compile-dll-using-golang-on-linux%2f" target="_blank" class="share-btn facebook">
    <i class="fa fa-facebook"></i>
    <p>Facebook</p>
  </a>
</li>


<li>
  <a href="//b.hatena.ne.jp/entry/kurousada.ga/posts/tech/cross-compile-dll-using-golang-on-linux/" target="_blank" class="share-btn hatena">
    <i class="icon-hatena"></i>
    <p>Hatena</p>
  </a>
</li>


<li>
  <a href="https://getpocket.com/save?url=http%3a%2f%2fkurousada.ga%2fposts%2ftech%2fcross-compile-dll-using-golang-on-linux%2f" target="_blank" class="share-btn pocket">
    <i class="fa fa-get-pocket"></i>
    <p>Pocket</p>
  </a>
</li>


<li>
  <a href="//reddit.com/submit?url=http%3a%2f%2fkurousada.ga%2fposts%2ftech%2fcross-compile-dll-using-golang-on-linux%2f&title=Go%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6DLL%e3%82%92%e3%82%af%e3%83%ad%e3%82%b9%e3%82%b3%e3%83%b3%e3%83%91%e3%82%a4%e3%83%ab%20on%20Linux" target="_blank" class="share-btn reddit">
    <i class="fa fa-reddit-alien"></i>
    <p>Reddit</p>
  </a>
</li>


<li>
  <a href="//www.linkedin.com/shareArticle?url=http%3a%2f%2fkurousada.ga%2fposts%2ftech%2fcross-compile-dll-using-golang-on-linux%2f&title=Go%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6DLL%e3%82%92%e3%82%af%e3%83%ad%e3%82%b9%e3%82%b3%e3%83%b3%e3%83%91%e3%82%a4%e3%83%ab%20on%20Linux" target="_blank" class="share-btn linkedin">
      <i class="fa fa-linkedin"></i>
      <p>LinkedIn</p>
    </a>
</li>


<li>
  <a href="//www.stumbleupon.com/submit?url=http%3a%2f%2fkurousada.ga%2fposts%2ftech%2fcross-compile-dll-using-golang-on-linux%2f&title=Go%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6DLL%e3%82%92%e3%82%af%e3%83%ad%e3%82%b9%e3%82%b3%e3%83%b3%e3%83%91%e3%82%a4%e3%83%ab%20on%20Linux" target="_blank" class="share-btn stumbleupon">
    <i class="fa fa-stumbleupon"></i>
    <p>StumbleUpon</p>
  </a>
</li>


<li>
  <a href="//www.pinterest.com/pin/create/button/?url=http%3a%2f%2fkurousada.ga%2fposts%2ftech%2fcross-compile-dll-using-golang-on-linux%2f&description=Go%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6DLL%e3%82%92%e3%82%af%e3%83%ad%e3%82%b9%e3%82%b3%e3%83%b3%e3%83%91%e3%82%a4%e3%83%ab%20on%20Linux" target="_blank" class="share-btn pinterest">
    <i class="fa fa-pinterest-p"></i>
    <p>Pinterest</p>
  </a>
</li>


<li>
  <a href="mailto:?subject=Check out this post by Kuro%20Usada&body=http%3a%2f%2fkurousada.ga%2fposts%2ftech%2fcross-compile-dll-using-golang-on-linux%2f" target="_blank" class="share-btn email">
    <i class="fa fa-envelope"></i>
    <p>Email</p>
  </a>
</li>

        </ul>
    </section>
</section>

        
    </div>
    
<section id="sidebar" class="navi">

    
        <section id="intro">
            
            
                
                    <a href="http://kurousada.ga/" class="logo"><img src="http://kurousada.ga/img/main/logo.png" alt="Kuro Usada" /></a>
                
            
            
                <header>
                    <h2>Kuro Usada ga!</h2>
                    <p>Kuro Usadaが楽しく遊ぶところです。<br>エサをあげると喜びます。</p>
                </header>
            
            <ul class="icons">
                
                    <li><a href="http://kurousada.ga/index.xml" type="application/rss+xml"
                        target="_blank" title="RSS" class="fa fa-rss"></a></li>
                
                
                    
  <li><a href="//github.com/kurousada" target="_blank" title="GitHub" class="fa fa-github"></a></li>



































































  <li><a href="mailto:kuro.usada&#43;email@gmail.com" title="Email" class="fa fa-envelope"></a></li>


                
            </ul>
        </section>

    
        <section id="recent-posts" class="navi-content">
            <ul class="posts">
                <header>
                    <h3>Recent Posts</h3>
                </header>
                
                    
                

                
                    
                

                
                    <li class="post">
                      <a class="post-link" href="http://kurousada.ga/posts/tech/cross-compile-dll-using-golang-on-linux/">
                        <article>
                            <header>
                                <h4 class="post-link-title">Goを使ってDLLをクロスコンパイル on Linux</h4>
                                
                                    
                                        
                                    
                                
                                <time class="published" datetime=
                                    '2017-12-01'>
                                    December 1, 2017</time>
                            </header>
                        </article>
                      </a>
                    </li>
                
                    <li class="post">
                      <a class="post-link" href="http://kurousada.ga/posts/disney/tds/eat-them-in-tokyo-disney-sea/">
                        <article>
                            <header>
                                <h4 class="post-link-title">ディズニーシーではこれを食え！</h4>
                                
                                    
                                        
                                    
                                
                                <time class="published" datetime=
                                    '2017-11-03'>
                                    November 3, 2017</time>
                            </header>
                        </article>
                      </a>
                    </li>
                
                    <li class="post">
                      <a class="post-link" href="http://kurousada.ga/posts/disney/tds/drink-them-in-tokyo-disney-sea/">
                        <article>
                            <header>
                                <h4 class="post-link-title">ディズニーシーではこれを飲め！</h4>
                                
                                    
                                        
                                    
                                
                                <time class="published" datetime=
                                    '2017-11-08'>
                                    November 8, 2017</time>
                            </header>
                        </article>
                      </a>
                    </li>
                
                    <li class="post">
                      <a class="post-link" href="http://kurousada.ga/posts/disney/disney-food-dogma/">
                        <article>
                            <header>
                                <h4 class="post-link-title">ディズニー・フードの鉄則</h4>
                                
                                    
                                        
                                    
                                
                                <time class="published" datetime=
                                    '2017-11-01'>
                                    November 1, 2017</time>
                            </header>
                        </article>
                      </a>
                    </li>
                
                    <li class="post">
                      <a class="post-link" href="http://kurousada.ga/posts/tech/how-to-get-back-old-times-offline/">
                        <article>
                            <header>
                                <h4 class="post-link-title">オフラインでも懐かしいあの頃に戻る方法</h4>
                                
                                    
                                        
                                    
                                
                                <time class="published" datetime=
                                    '2017-10-31'>
                                    October 31, 2017</time>
                            </header>
                        </article>
                      </a>
                    </li>
                

                
                    <li class="post more-post">
                        <ul class="actions">
                            <li><a href=
                            
                                /posts/
                            
                            class="button">View more posts</a></li>
                        </ul>
                    </li>
                
            </ul>
        </section>

    
    
    
    
        <section id="categories" class="navi-content">
            <ul class="posts">
                <header>
                    <h3><a href="http://kurousada.ga/categories/">Categories</a></h3>
                </header>

                
                    
                

                
                    <li class="post">
                      <a class="post-link" href="http://kurousada.ga/categories/disney/">
                        <article>
                            <header>
                                <h4 class="post-link-title">Disney</h4>
                                <span style="float:right;">6</span>
                            </header>
                        </article>
                      </a>
                    </li>
                
                    <li class="post">
                      <a class="post-link" href="http://kurousada.ga/categories/tds/">
                        <article>
                            <header>
                                <h4 class="post-link-title">TDS</h4>
                                <span style="float:right;">6</span>
                            </header>
                        </article>
                      </a>
                    </li>
                
                    <li class="post">
                      <a class="post-link" href="http://kurousada.ga/categories/tech/">
                        <article>
                            <header>
                                <h4 class="post-link-title">tech</h4>
                                <span style="float:right;">4</span>
                            </header>
                        </article>
                      </a>
                    </li>
                
                    <li class="post">
                      <a class="post-link" href="http://kurousada.ga/categories/food/">
                        <article>
                            <header>
                                <h4 class="post-link-title">food</h4>
                                <span style="float:right;">3</span>
                            </header>
                        </article>
                      </a>
                    </li>
                
                    <li class="post">
                      <a class="post-link" href="http://kurousada.ga/categories/linux/">
                        <article>
                            <header>
                                <h4 class="post-link-title">Linux</h4>
                                <span style="float:right;">2</span>
                            </header>
                        </article>
                      </a>
                    </li>
                
                    <li class="post">
                      <a class="post-link" href="http://kurousada.ga/categories/tdl/">
                        <article>
                            <header>
                                <h4 class="post-link-title">TDL</h4>
                                <span style="float:right;">2</span>
                            </header>
                        </article>
                      </a>
                    </li>
                
                    <li class="post">
                      <a class="post-link" href="http://kurousada.ga/categories/favorites/">
                        <article>
                            <header>
                                <h4 class="post-link-title">favorites</h4>
                                <span style="float:right;">2</span>
                            </header>
                        </article>
                      </a>
                    </li>
                
                    <li class="post">
                      <a class="post-link" href="http://kurousada.ga/categories/narcissu/">
                        <article>
                            <header>
                                <h4 class="post-link-title">narcissu</h4>
                                <span style="float:right;">2</span>
                            </header>
                        </article>
                      </a>
                    </li>
                
                    <li class="post">
                      <a class="post-link" href="http://kurousada.ga/categories/linux-mint/">
                        <article>
                            <header>
                                <h4 class="post-link-title">Linux Mint</h4>
                                <span style="float:right;">1</span>
                            </header>
                        </article>
                      </a>
                    </li>
                
                    <li class="post">
                      <a class="post-link" href="http://kurousada.ga/categories/eva/">
                        <article>
                            <header>
                                <h4 class="post-link-title">eva</h4>
                                <span style="float:right;">1</span>
                            </header>
                        </article>
                      </a>
                    </li>
                
                    <li class="post">
                      <a class="post-link" href="http://kurousada.ga/categories/github/">
                        <article>
                            <header>
                                <h4 class="post-link-title">github</h4>
                                <span style="float:right;">1</span>
                            </header>
                        </article>
                      </a>
                    </li>
                
                    <li class="post">
                      <a class="post-link" href="http://kurousada.ga/categories/gits/">
                        <article>
                            <header>
                                <h4 class="post-link-title">gits</h4>
                                <span style="float:right;">1</span>
                            </header>
                        </article>
                      </a>
                    </li>
                
                    <li class="post">
                      <a class="post-link" href="http://kurousada.ga/categories/golang/">
                        <article>
                            <header>
                                <h4 class="post-link-title">golang</h4>
                                <span style="float:right;">1</span>
                            </header>
                        </article>
                      </a>
                    </li>
                
                    <li class="post">
                      <a class="post-link" href="http://kurousada.ga/categories/ukagaka/">
                        <article>
                            <header>
                                <h4 class="post-link-title">ukagaka</h4>
                                <span style="float:right;">1</span>
                            </header>
                        </article>
                      </a>
                    </li>
                
            </ul>
        </section>
    

    
        
        <section id="intro-about" class="blurb" class="navi-content">
            <header>
              <h2>About</h2>
            </header>
            <p class="navi-content-content">Ladies and gentlemen, boys and girls. Kuro Usada ga! presented by Kuro Usada has began just a few months ago.　Every time, Kuro Usada uses his vivid imagination to create magical imagery for all to enjoy. Nothing is more wonderful than the imagination. It can be a beautiful fantasy. Or, an exciting adventure! But beware — imagination also expand your greatest fears into a nightmare. Now, get ready for a journey beyond your wildest imagination...</p>

            <ul class="actions">
                <li><a href="http://kurousada.ga/about/" class="button">Learn More</a></li>
            </ul>
        </section>
        

    
        
        
        

    
        <section id="footer">
            <p class="notice">Check our <a href="privacy-policy">Privacy Policy</a>.</p>
            <p class="notice">This web site works best on the latest version of <a href="vivaldi.com">Vivaldi</a> for Linux.</p>
            <ul class="icons">
                
                    <li><a href="http://kurousada.ga/index.xml" type="application/rss+xml"
                        target="_blank" title="RSS" class="fa fa-rss"></a></li>
                
                
                    
  <li><a href="//github.com/kurousada" target="_blank" title="GitHub" class="fa fa-github"></a></li>



































































  <li><a href="mailto:kuro.usada&#43;email@gmail.com" title="Email" class="fa fa-envelope"></a></li>


                
            </ul>

            <p class="copyright">&copy; Kuro Usada ga! by Kuro Usada. Designed by <a href="http://html5up.net" target="_blank">HTML5 UP</a>, Ported by <a href="//github.com/jpescador" target="_blank">Julio Pescador</a>. Powered by <a href="//gohugo.io" target="_blank">Hugo</a></p>
        </section>

</section>

            </div>
        
        

        
        
        
        
            
        

        
        

        
            
            
                
                    <script src="http://kurousada.ga/js/site.min.js"></script>
                
            
            
        

        
            <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        
        <script>
          window.addEventListener( 'load', function () {
            (adsbygoogle = window.adsbygoogle || []).push({
              google_ad_client: "ca-pub-2419792064448421",
              enable_page_level_ads: true
            });
            Array.prototype.forEach.call( document.querySelectorAll( "a[href^='http']:not([href*='" + location.hostname + "'])" ), function( el ){
              el.setAttribute( 'target', '_blank' )
            } );
            if ( lightbox ) {
              const marginTop = 15
              const header = document.querySelector( '#header' )
              const headerHeight = parseInt( window.getComputedStyle( header, '' ).height.slice( 0, -2 ), 10 )
              const lightboxPosFromTop = headerHeight + marginTop
              lightbox.option({
                "alwaysShowNavOnTouchDevices": true,
                "fitImagesInViewport": true,
                "positionFromTop": lightboxPosFromTop,
                "wrapAround": true
              })
            }
            if ( hljs ) {
              hljs.initHighlightingOnLoad();
            }
          }, false)
        </script>
        
    </body>
</html>

